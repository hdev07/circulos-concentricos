<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <title>Mapa de Zonas de Riesgo - CTM El Risco</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    body {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 0;
    }

    .container {
      max-width: none;
      margin: 0;
      padding: 20px;
    }

    .header {
      background: white;
      border-radius: 20px;
      padding: 20px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
      max-width: 1400px;
      margin: 0 auto 20px auto;
    }

    .header h1 {
      color: #2c3e50;
      font-size: 2.5rem;
      text-align: center;
      margin-bottom: 10px;
      font-weight: 700;
    }

    .subtitle {
      text-align: center;
      color: #7f8c8d;
      font-size: 1.2rem;
      margin-bottom: 30px;
    }

    .filtros-container {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 20px;
      margin-bottom: 20px;
    }

    .filtro-card {
      background: #f8f9fa;
      border-radius: 15px;
      padding: 20px;
      border: 2px solid #e9ecef;
      transition: all 0.3s ease;
    }

    .filtro-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
      border-color: #667eea;
    }

    .filtro-card h3 {
      color: #2c3e50;
      font-size: 1.3rem;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .filtro-card select {
      width: 100%;
      padding: 12px;
      border: 2px solid #e9ecef;
      border-radius: 10px;
      font-size: 1rem;
      background: white;
      transition: border-color 0.3s ease;
    }

    .filtro-card select:focus {
      outline: none;
      border-color: #667eea;
    }

    .tipos-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
      max-height: 200px;
      overflow-y: auto;
      background: white;
      padding: 15px;
      border-radius: 10px;
      border: 2px solid #e9ecef;
    }

    .tipo-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 5px;
      font-size: 0.9rem;
    }

    .tipo-item input[type="checkbox"] {
      width: 18px;
      height: 18px;
      accent-color: #667eea;
    }

    .botones-container {
      display: flex;
      gap: 15px;
      justify-content: center;
    }

    .btn {
      padding: 12px 25px;
      border: none;
      border-radius: 25px;
      font-size: 1.1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .btn-primary {
      background: linear-gradient(45deg, #667eea, #764ba2);
      color: white;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
    }

    .btn-secondary {
      background: #6c757d;
      color: white;
    }

    .btn-secondary:hover {
      background: #5a6268;
      transform: translateY(-2px);
    }

    .mapa-container {
      background: white;
      border-radius: 20px;
      padding: 20px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
      position: relative;
      margin: 0 -20px;
      border-radius: 0;
    }

    .mapa-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      flex-wrap: wrap;
      gap: 15px;
    }

    .mapa-title {
      color: #2c3e50;
      font-size: 1.8rem;
      font-weight: 600;
      margin: 0;
    }

    .controles-mapa {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .control-btn {
      padding: 10px 15px;
      background: #f8f9fa;
      border: 2px solid #e9ecef;
      border-radius: 15px;
      cursor: pointer;
      font-size: 0.9rem;
      font-weight: 500;
      transition: all 0.3s ease;
      color: #495057;
    }

    .control-btn:hover {
      background: #667eea;
      color: white;
      border-color: #667eea;
      transform: translateY(-1px);
    }

    .control-btn.activo {
      background: #28a745;
      color: white;
      border-color: #28a745;
    }

    .control-btn.inactivo {
      background: #dc3545;
      color: white;
      border-color: #dc3545;
      opacity: 0.8;
    }

    #map {
      height: 70vh;
      width: 100%;
      border-radius: 15px;
      overflow: hidden;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
    }

    .estadisticas {
      position: absolute;
      top: 90px;
      right: 30px;
      background: rgba(255, 255, 255, 0.95);
      padding: 20px 20px 20px 20px;
      border-radius: 15px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
      z-index: 1000;
      min-width: 220px;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .estadisticas h4 {
      color: #2c3e50;
      margin: 0 0 15px 0;
      font-size: 1.2rem;
      text-align: center;
      border-bottom: 2px solid #667eea;
      padding-bottom: 8px;
    }

    .stat-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
      font-size: 0.95rem;
      padding: 5px 0;
    }

    .stat-number {
      font-weight: 700;
      color: #667eea;
      font-size: 1.1rem;
      background: rgba(102, 126, 234, 0.1);
      padding: 4px 8px;
      border-radius: 8px;
    }

    .leyenda {
      padding: 15px;
      background: rgba(255, 255, 255, 0.95);
      border-radius: 15px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
      max-height: 300px;
      overflow-y: auto;
      width: 280px;
    }

    .leyenda h4 {
      margin: 0 0 15px;
      font-size: 1.2rem;
      color: #2c3e50;
      border-bottom: 2px solid #667eea;
      padding-bottom: 8px;
    }

    .leyenda-item {
      display: flex;
      align-items: center;
      margin-bottom: 8px;
      padding: 5px;
      border-radius: 8px;
      transition: background 0.2s ease;
    }

    .leyenda-item:hover {
      background: #f8f9fa;
    }

    .color-box {
      width: 20px;
      height: 20px;
      margin-right: 12px;
      border-radius: 5px;
      border: 1px solid rgba(0, 0, 0, 0.1);
    }

    .loading {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      padding: 30px;
      border-radius: 20px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
      z-index: 2000;
      text-align: center;
    }

    .loading h3 {
      color: #2c3e50;
      margin-bottom: 15px;
    }

    .spinner {
      width: 40px;
      height: 40px;
      border: 4px solid #f3f3f3;
      border-top: 4px solid #667eea;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto;
    }

    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }

      100% {
        transform: rotate(360deg);
      }
    }

    .error {
      background: #f8d7da;
      color: #721c24;
      border: 2px solid #f5c6cb;
    }

    .notificacion {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.8);
      color: white;
      padding: 15px 25px;
      border-radius: 25px;
      z-index: 2000;
      font-size: 1rem;
      font-weight: 500;
    }

    .resultados-filtro {
      background: #e8f4fd;
      border: 1px solid #bee5eb;
      border-radius: 10px;
      padding: 15px;
      margin-top: 15px;
      text-align: center;
    }

    .resultados-filtro strong {
      color: #2c3e50;
      font-size: 1.1rem;
    }

    /* Responsivo */
    @media (max-width: 768px) {
      .container {
        padding: 10px;
        /* Reducimos padding en m√≥viles */
      }

      .mapa-container {
        margin: 0 -10px;
        /* Ajustamos el margen negativo para m√≥viles */
      }

      .filtros-container {
        grid-template-columns: 1fr;
      }

      .header h1 {
        font-size: 2rem;
      }

      .botones-container {
        flex-direction: column;
      }

      .controles-mapa {
        flex-wrap: wrap;
        justify-content: center;
      }

      .mapa-header {
        flex-direction: column;
        text-align: center;
      }

      .estadisticas {
        position: static;
        margin: 15px auto 0;
        width: fit-content;
        max-width: 90%;
      }

      #map {
        height: 50vh;
      }
    }
  </style>
</head>

<body>
  <div class="container">
    <!-- Header con t√≠tulo -->
    <div class="header">
      <h1>üó∫Ô∏è Mapa de Seguridad</h1>
      <p class="subtitle">CTM El Risco - Encuentra las zonas m√°s seguras</p>

      <!-- Filtros principales -->
      <div class="filtros-container">
        <div class="filtro-card">
          <h3>üìä Tipos de Delito</h3>
          <div class="tipos-grid" id="tipos-delito">
            <!-- Se llenar√°n din√°micamente -->
          </div>
        </div>

        <div class="filtro-card">
          <h3>üóìÔ∏è A√±o</h3>
          <select id="filtro-ano">
            <option value="">Todos los a√±os</option>
            <!-- Se llenar√°n din√°micamente -->
          </select>
        </div>

        <div class="filtro-card">
          <h3>üìà Nivel de Peligro</h3>
          <select id="nivel-riesgo">
            <option value="1">üü¢ Mostrar todo</option>
            <option value="2">üü° Medio peligro o m√°s</option>
            <option value="3">üü† Alto peligro o m√°s</option>
            <option value="5">üî¥ Solo muy peligroso</option>
          </select>
        </div>
      </div>

      <!-- Botones de acci√≥n -->
      <div class="botones-container">
        <button class="btn btn-primary" id="btn-aplicar-filtros">
          ‚ú® Aplicar Filtros
        </button>
        <button class="btn btn-secondary" id="btn-limpiar-filtros">
          üßπ Limpiar Todo
        </button>
      </div>

      <!-- Resultados de filtros -->
      <div class="resultados-filtro" id="resultados-filtro" style="display: none;">
        <!-- Se mostrar√° informaci√≥n de los filtros aplicados -->
      </div>
    </div>

    <!-- Container del mapa -->
    <div class="mapa-container">
      <div class="mapa-header">
        <h2 class="mapa-title">üèòÔ∏è Mapa Interactivo</h2>
        <div class="controles-mapa">
          <button class="control-btn" id="btn-centrar">üéØ Centrar</button>
          <button class="control-btn" id="btn-toggle-puntos">üìç Puntos</button>
          <button class="control-btn" id="btn-toggle-zonas">üîµ Zonas</button>
          <button class="control-btn" id="btn-cambiar-mapa">üó∫Ô∏è Cambiar Mapa</button>
          <button class="control-btn" id="btn-toggle-estadisticas">üìä Estad√≠sticas</button>
          <button class="control-btn" id="btn-toggle-leyenda">üîç Leyenda</button>
        </div>
      </div>

      <div id="map"></div>

      <!-- Estad√≠sticas flotantes -->
      <div class="estadisticas" id="estadisticas" style="display: none;">
        <h4>üìä Estad√≠sticas</h4>
        <div class="stat-item">
          <span>Total delitos:</span>
          <span class="stat-number" id="total-delitos-num">0</span>
        </div>
        <div class="stat-item">
          <span>Tipos:</span>
          <span class="stat-number" id="tipos-delitos-num">0</span>
        </div>
        <div class="stat-item">
          <span>Filtrados:</span>
          <span class="stat-number" id="delitos-mostrados">0</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Loading -->
  <div class="loading" id="loading">
    <h3>üîÑ Cargando mapa...</h3>
    <div class="spinner"></div>
    <p>Preparando datos de seguridad</p>
  </div>

  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
  <script src="https://unpkg.com/@turf/turf@6/turf.min.js"></script>
  <script src="delitos_data.js"></script>
  <script>
    // Variables globales
    let map;
    let delitosData = [];
    let delitosOriginales = []; // Datos sin filtrar
    let puntosLayer;
    let zonasRiesgoLayer;
    let leyendaControl;
    let mostrandoPuntos = true;  // Cambiado: Puntos activos por defecto
    let mostrandoZonas = false;  // Cambiado: Zonas desactivadas por defecto
    let mostrandoEstadisticas = true;
    let mostrandoLeyenda = true;
    let currentTileLayer;
    let tipoMapaActual = 2;  // Cambiado: H√≠brido por defecto (√≠ndice 2)
    let filtrosActivos = {
      tiposDelito: [],
      ano: '',
      nivelRiesgo: 1
    };

    // Configuraciones de diferentes mapas
    const tiposMapas = [
      {
        nombre: 'Google Maps Est√°ndar',
        url: 'https://mt1.google.com/vt/lyrs=r&x={x}&y={y}&z={z}',
        attribution: '&copy; <a href="https://www.google.com/maps">Google Maps</a>'
      },
      {
        nombre: 'Google Maps Sat√©lite',
        url: 'https://mt1.google.com/vt/lyrs=s&x={x}&y={y}&z={z}',
        attribution: '&copy; <a href="https://www.google.com/maps">Google Maps</a>'
      },
      {
        nombre: 'Google Maps H√≠brido',
        url: 'https://mt1.google.com/vt/lyrs=y&x={x}&y={y}&z={z}',
        attribution: '&copy; <a href="https://www.google.com/maps">Google Maps</a>'
      },
      {
        nombre: 'OpenStreetMap',
        url: 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
      }
    ];

    // Funci√≥n para obtener los datos de delitos
    function obtenerDelitosData() {
      try {
        if (typeof DELITOS_DATA !== 'undefined' && DELITOS_DATA.length > 0) {
          console.log(`Delitos cargados: ${DELITOS_DATA.length}`);
          return DELITOS_DATA;
        } else {
          throw new Error('No se encontraron datos de delitos');
        }
      } catch (error) {
        console.error('Error obteniendo datos de delitos:', error);
        mostrarError('Error obteniendo datos de delitos: ' + error.message);
        return [];
      }
    }

    // Pol√≠gono real de CTM El Risco
    const poligonoElRisco = {
      "type": "Feature",
      "geometry": {
        "type": "Polygon",
        "coordinates": [[
          [-99.09740966399839, 19.51266487533441],
          [-99.10056001114475, 19.51184350019888],
          [-99.1006093896991, 19.511303564087626],
          [-99.09965400636638, 19.509148468250586],
          [-99.09932498626866, 19.509227827856975],
          [-99.098853531969, 19.509016322113567],
          [-99.09863095442408, 19.509346968554595],
          [-99.0981457328141, 19.509095591825343],
          [-99.09843057741668, 19.508495805177503],
          [-99.09604558848774, 19.50725339452788],
          [-99.09533437072858, 19.5074291381071],
          [-99.09286947300322, 19.506017748674992],
          [-99.09259666715131, 19.505876914674985],
          [-99.09040664577094, 19.5095740415083],
          [-99.09493725520933, 19.51130173772033],
          [-99.09740966399839, 19.51266487533441]
        ]]
      }
    };

    // Funci√≥n para mostrar error
    function mostrarError(mensaje) {
      const loading = document.getElementById('loading');
      loading.innerHTML = `
        <h3>‚ùå Error</h3>
        <p>${mensaje}</p>
      `;
      loading.classList.add('error');
      console.error(mensaje);
    }

    // Funci√≥n para mostrar notificaci√≥n
    function mostrarNotificacion(mensaje, duracion = 3000) {
      // Crear o actualizar notificaci√≥n
      let notificacion = document.getElementById('notificacion-general');
      if (!notificacion) {
        notificacion = document.createElement('div');
        notificacion.id = 'notificacion-general';
        notificacion.className = 'notificacion';
        document.body.appendChild(notificacion);
      }

      notificacion.textContent = mensaje;
      notificacion.style.display = 'block';

      // Ocultar despu√©s del tiempo especificado
      setTimeout(() => {
        notificacion.style.display = 'none';
      }, duracion);
    }

    // Verificar si las librer√≠as est√°n cargadas
    function verificarLibrerias() {
      if (typeof L === 'undefined') {
        mostrarError('Error: No se pudo cargar la librer√≠a Leaflet');
        return false;
      }
      if (typeof turf === 'undefined') {
        mostrarError('Error: No se pudo cargar la librer√≠a Turf.js');
        return false;
      }
      return true;
    }

    // Inicializar el mapa
    function initMap() {
      try {
        if (!verificarLibrerias()) return;

        map = L.map('map').setView([19.510, -99.096], 15);
        currentTileLayer = L.tileLayer(tiposMapas[tipoMapaActual].url, {
          maxZoom: 20,
          attribution: tiposMapas[tipoMapaActual].attribution
        }).addTo(map);

        // Crear las capas pero solo agregar al mapa las que est√°n activas
        puntosLayer = L.layerGroup();
        zonasRiesgoLayer = L.layerGroup();

        // Agregar capas al mapa seg√∫n el estado inicial
        if (mostrandoPuntos) {
          puntosLayer.addTo(map);
        }
        if (mostrandoZonas) {
          zonasRiesgoLayer.addTo(map);
        }

        console.log('Mapa inicializado con estado:', {
          puntos: mostrandoPuntos ? 'visible' : 'oculto',
          zonas: mostrandoZonas ? 'visible' : 'oculto'
        });

        return true;
      } catch (error) {
        mostrarError('Error inicializando el mapa: ' + error.message);
        return false;
      }
    }

    // Procesar datos de delitos
    function procesarDelitos() {
      try {
        document.getElementById('loading').innerHTML = `
          <h3>üìä Cargando datos...</h3>
          <div class="spinner"></div>
          <p>Procesando informaci√≥n de delitos</p>
        `;

        // Cargar datos desde el archivo JavaScript
        const delitosRaw = obtenerDelitosData();

        if (delitosRaw.length === 0) {
          mostrarError('No se pudieron cargar los datos de delitos');
          return;
        }

        document.getElementById('loading').innerHTML = `
          <h3>üîç Analizando zona...</h3>
          <div class="spinner"></div>
          <p>Filtrando delitos en el √°rea</p>
        `;

        // Filtrar delitos dentro del pol√≠gono
        const turfPolygon = turf.polygon(poligonoElRisco.geometry.coordinates);
        const delitosFiltrados = delitosRaw.filter(delito => {
          const punto = turf.point([delito.lng, delito.lat]);
          return turf.booleanPointInPolygon(punto, turfPolygon);
        });

        delitosData = delitosFiltrados;

        console.log(`Delitos procesados: ${delitosData.length}`);

        if (delitosData.length === 0) {
          mostrarError('No se encontraron delitos en el √°rea especificada');
          return;
        }

        // Guardar datos originales para filtros
        delitosOriginales = [...delitosData];

        // Crear visualizaciones
        crearPuntosDelitos();
        crearZonasRiesgoSimples();
        actualizarEstadisticas();

        // Inicializar filtros
        inicializarFiltros();

        // Ocultar loading y mostrar interfaz
        document.getElementById('loading').style.display = 'none';
        document.getElementById('estadisticas').style.display = 'block';

        // Inicializar estado de botones
        inicializarEstadoBotones();

        // Mostrar notificaci√≥n de √©xito
        mostrarNotificacion('‚úÖ Mapa cargado correctamente');

        // Notificaci√≥n adicional sobre el tipo de mapa
        setTimeout(() => {
          mostrarNotificacion(`üõ∞Ô∏è Vista: ${tiposMapas[tipoMapaActual].nombre}`, 3000);
        }, 1500);

      } catch (error) {
        mostrarError('Error procesando datos: ' + error.message);
      }
    }

    // Crear zonas de riesgo simplificadas (c√≠rculos alrededor de concentraciones)
    function crearZonasRiesgoSimples() {
      try {
        // Agrupar delitos por proximidad
        const grupos = [];
        const radio = 100; // 100 metros de radio

        delitosData.forEach(delito => {
          let grupoEncontrado = false;

          for (let grupo of grupos) {
            const distancia = turf.distance(
              turf.point([delito.lng, delito.lat]),
              turf.point([grupo.centro.lng, grupo.centro.lat]),
              { units: 'meters' }
            );

            if (distancia <= radio) {
              grupo.delitos.push(delito);
              grupoEncontrado = true;
              break;
            }
          }

          if (!grupoEncontrado) {
            grupos.push({
              centro: { lat: delito.lat, lng: delito.lng },
              delitos: [delito]
            });
          }
        });

        // Crear c√≠rculos para cada grupo
        grupos.forEach(grupo => {
          const cantidad = grupo.delitos.length;
          let color, nivelRiesgo, emoji;

          if (cantidad >= 5) {
            color = '#ff4757';
            nivelRiesgo = 'Muy Peligroso';
            emoji = 'üî¥';
          } else if (cantidad >= 3) {
            color = '#ff6b7a';
            nivelRiesgo = 'Peligroso';
            emoji = 'üü†';
          } else if (cantidad >= 2) {
            color = '#ffa726';
            nivelRiesgo = 'Precauci√≥n';
            emoji = 'üü°';
          } else {
            color = '#26de81';
            nivelRiesgo = 'Seguro';
            emoji = 'üü¢';
          }

          const circle = L.circle([grupo.centro.lat, grupo.centro.lng], {
            radius: radio,
            fillColor: color,
            fillOpacity: 0.3,
            color: color,
            weight: 3,
            opacity: 0.8
          }).bindPopup(`
            <div style="text-align: center; font-size: 14px;">
              <strong>${emoji} ${nivelRiesgo}</strong><br>
              <br>üìä ${cantidad} delitos registrados<br>
              üìè Radio: ${radio} metros<br>
              <small>Haz clic en los puntos para ver detalles</small>
            </div>
          `);

          zonasRiesgoLayer.addLayer(circle);
        });

        // Crear leyenda
        crearLeyendaZonas();

      } catch (error) {
        console.error('Error creando zonas de riesgo:', error);
        // Continuar sin zonas de riesgo
      }
    }

    // Crear puntos de delitos individuales
    function crearPuntosDelitos() {
      try {
        const coloresDelitos = {
          'Violencia Familiar': '#e74c3c',
          'Robo': '#3498db',
          'Amenazas': '#2ecc71',
          'Da√±o A La Propiedad': '#9b59b6',
          'Fraude': '#e67e22',
          'Usurpaci√≥n': '#f1c40f',
          'Tentativa': '#e91e63',
          'Lesiones Culposas': '#26a69a',
          'Despojo': '#ff7043',
          'Allanamiento': '#5c6bc0',
          'Encubrimiento': '#fdd835'
        };

        delitosData.forEach(delito => {
          const color = coloresDelitos[delito.tipoDelito] || '#34495e';

          const marker = L.circleMarker([delito.lat, delito.lng], {
            radius: 8,
            fillColor: color,
            color: '#ffffff',
            weight: 2,
            opacity: 1,
            fillOpacity: 0.8
          }).bindPopup(`
            <div style="text-align: center; font-size: 13px;">
              <strong style="color: ${color};">üìã ${delito.tipoDelito}</strong><br>
              <br>üìÖ <strong>Fecha:</strong> ${delito.fecha}<br>
              ‚è∞ <strong>Hora:</strong> ${delito.hora}<br>
              üìç <strong>Ubicaci√≥n:</strong><br>
              <small>${delito.lat.toFixed(6)}, ${delito.lng.toFixed(6)}</small>
            </div>
          `);

          puntosLayer.addLayer(marker);
        });

      } catch (error) {
        console.error('Error creando puntos:', error);
      }
    }

    // Crear leyenda
    function crearLeyendaZonas() {
      try {
        // Primero remover la leyenda existente
        if (leyendaControl) {
          map.removeControl(leyendaControl);
        }

        // Solo crear la leyenda si debe estar visible
        if (!mostrandoLeyenda) {
          return;
        }

        leyendaControl = L.control({ position: 'bottomleft' });
        leyendaControl.onAdd = function () {
          const div = L.DomUtil.create('div', 'leyenda');
          div.innerHTML = '<h4>üîç Niveles de Seguridad</h4>';

          const niveles = [
            { nivel: 'Seguro', color: '#26de81', desc: '1 delito', emoji: 'üü¢' },
            { nivel: 'Precauci√≥n', color: '#ffa726', desc: '2 delitos', emoji: 'üü°' },
            { nivel: 'Peligroso', color: '#ff6b7a', desc: '3-4 delitos', emoji: 'üü†' },
            { nivel: 'Muy Peligroso', color: '#ff4757', desc: '5+ delitos', emoji: 'üî¥' }
          ];

          niveles.forEach(item => {
            div.innerHTML += `
              <div class="leyenda-item">
                <div class="color-box" style="background: ${item.color}"></div>
                <span>${item.emoji} ${item.nivel} (${item.desc})</span>
              </div>
            `;
          });

          return div;
        };
        leyendaControl.addTo(map);

      } catch (error) {
        console.error('Error creando leyenda:', error);
      }
    }

    // Actualizar estad√≠sticas
    function actualizarEstadisticas() {
      try {
        const totalDelitos = delitosData.length;
        const tiposDelitos = [...new Set(delitosData.map(d => d.tipoDelito))].length;
        const totalOriginales = delitosOriginales.length;

        document.getElementById('total-delitos-num').textContent = totalOriginales;
        document.getElementById('tipos-delitos-num').textContent = tiposDelitos;
        document.getElementById('delitos-mostrados').textContent = totalDelitos;
      } catch (error) {
        console.error('Error actualizando estad√≠sticas:', error);
      }
    }

    // Event listeners
    function setupEventListeners() {
      try {
        document.getElementById('btn-centrar').addEventListener('click', function () {
          const poligonoLayer = L.geoJSON(poligonoElRisco, {
            style: { color: '#667eea', fillOpacity: 0.1, weight: 3 }
          });
          map.fitBounds(poligonoLayer.getBounds());
          mostrarNotificacion('üéØ Mapa centrado en CTM El Risco');
        });

        document.getElementById('btn-toggle-puntos').addEventListener('click', function () {
          const botonEl = document.getElementById('btn-toggle-puntos');
          if (mostrandoPuntos) {
            map.removeLayer(puntosLayer);
            mostrandoPuntos = false;
            botonEl.classList.remove('activo');
            botonEl.classList.add('inactivo');
            mostrarNotificacion('üìç Puntos ocultados');
          } else {
            map.addLayer(puntosLayer);
            mostrandoPuntos = true;
            botonEl.classList.remove('inactivo');
            botonEl.classList.add('activo');
            mostrarNotificacion('üìç Puntos mostrados');
          }
        });

        document.getElementById('btn-toggle-zonas').addEventListener('click', function () {
          const botonEl = document.getElementById('btn-toggle-zonas');
          if (mostrandoZonas) {
            map.removeLayer(zonasRiesgoLayer);
            mostrandoZonas = false;
            botonEl.classList.remove('activo');
            botonEl.classList.add('inactivo');
            mostrarNotificacion('üîµ Zonas de riesgo ocultadas');
          } else {
            map.addLayer(zonasRiesgoLayer);
            mostrandoZonas = true;
            botonEl.classList.remove('inactivo');
            botonEl.classList.add('activo');
            mostrarNotificacion('üîµ Zonas de riesgo mostradas');
          }
        });

        // Event listeners para filtros
        document.getElementById('btn-aplicar-filtros').addEventListener('click', aplicarFiltros);
        document.getElementById('btn-limpiar-filtros').addEventListener('click', limpiarFiltros);

        // Event listener para aplicar filtros autom√°ticamente al cambiar algunos campos
        document.getElementById('filtro-ano').addEventListener('change', aplicarFiltros);
        document.getElementById('nivel-riesgo').addEventListener('change', aplicarFiltros);

        // Event listener para cambiar tipo de mapa
        document.getElementById('btn-cambiar-mapa').addEventListener('click', cambiarTipoMapa);

        // Event listeners para toggle de estad√≠sticas y leyenda
        document.getElementById('btn-toggle-estadisticas').addEventListener('click', toggleEstadisticas);
        document.getElementById('btn-toggle-leyenda').addEventListener('click', toggleLeyenda);

      } catch (error) {
        console.error('Error configurando eventos:', error);
      }
    }

    // Inicializaci√≥n principal
    function inicializar() {
      try {
        // Verificar que las librer√≠as est√©n disponibles
        if (!verificarLibrerias()) {
          setTimeout(inicializar, 1000); // Reintentar en 1 segundo
          return;
        }

        // Inicializar mapa
        if (!initMap()) return;

        // A√±adir el pol√≠gono al mapa
        const poligonoLayer = L.geoJSON(poligonoElRisco, {
          style: {
            color: '#667eea',
            fillOpacity: 0.1,
            weight: 3
          }
        }).addTo(map);

        // Ajustar la vista al pol√≠gono
        map.fitBounds(poligonoLayer.getBounds());

        // Procesar datos despu√©s de un peque√±o retraso
        setTimeout(() => {
          procesarDelitos();
          setupEventListeners();
        }, 500);

      } catch (error) {
        mostrarError('Error de inicializaci√≥n: ' + error.message);
      }
    }

    // Esperar a que el DOM est√© listo
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', inicializar);
    } else {
      inicializar();
    }

    // Funciones para manejo de filtros
    function inicializarFiltros() {
      try {
        // Obtener todos los tipos de delito √∫nicos
        const tiposUnicos = [...new Set(delitosOriginales.map(d => d.tipoDelito))].sort();
        const tiposContainer = document.getElementById('tipos-delito');
        tiposContainer.innerHTML = '';

        tiposUnicos.forEach(tipo => {
          const tipoItem = document.createElement('div');
          tipoItem.className = 'tipo-item';
          tipoItem.innerHTML = `
            <input type="checkbox" id="tipo-${tipo.replace(/\s+/g, '-')}" value="${tipo}" checked>
            <label for="tipo-${tipo.replace(/\s+/g, '-')}">${tipo}</label>
          `;
          tiposContainer.appendChild(tipoItem);
        });

        // Obtener a√±os √∫nicos
        const anos = [...new Set(delitosOriginales.map(d => {
          let ano;

          // Manejar diferentes formatos de fecha
          if (typeof d.fecha === 'string' && d.fecha.includes('/')) {
            // Formato DD/MM/YYYY
            const fecha = d.fecha.split('/');
            ano = fecha[2];
          } else if (typeof d.fecha === 'number') {
            // Timestamp
            const fechaObj = new Date(d.fecha);
            ano = fechaObj.getFullYear().toString();
          } else if (typeof d.fecha === 'string' && d.fecha.includes('-')) {
            // Formato YYYY-MM-DD
            ano = d.fecha.split('-')[0];
          } else {
            // Intentar crear fecha y extraer a√±o
            try {
              const fechaObj = new Date(d.fecha);
              ano = fechaObj.getFullYear().toString();
            } catch (error) {
              console.warn('Formato de fecha no reconocido:', d.fecha);
              ano = 'Desconocido';
            }
          }

          return ano;
        }).filter(ano => ano && ano !== 'Desconocido' && ano !== 'NaN'))].sort();

        const anoSelect = document.getElementById('filtro-ano');
        // Limpiar opciones existentes excepto la primera
        while (anoSelect.children.length > 1) {
          anoSelect.removeChild(anoSelect.lastChild);
        }

        anos.forEach(ano => {
          const option = document.createElement('option');
          option.value = ano;
          option.textContent = ano;
          anoSelect.appendChild(option);
        });

        console.log('A√±os encontrados:', anos);
        console.log('Filtros inicializados correctamente');
      } catch (error) {
        console.error('Error inicializando filtros:', error);
      }
    }

    function aplicarFiltros() {
      try {
        const anoSeleccionado = document.getElementById('filtro-ano').value;
        const nivelRiesgo = parseInt(document.getElementById('nivel-riesgo').value);

        // Obtener tipos de delito seleccionados
        const tiposSeleccionados = [];
        document.querySelectorAll('#tipos-delito input[type="checkbox"]:checked').forEach(checkbox => {
          tiposSeleccionados.push(checkbox.value);
        });

        console.log('Aplicando filtros:', {
          anoSeleccionado, nivelRiesgo,
          tiposSeleccionados: tiposSeleccionados.length
        });

        // Filtrar datos
        let datosFiltrados = delitosOriginales.filter(delito => {
          // Filtro por tipo de delito
          if (tiposSeleccionados.length > 0 && !tiposSeleccionados.includes(delito.tipoDelito)) {
            return false;
          }

          // Filtro por a√±o
          if (anoSeleccionado) {
            let anoDelito;

            // Manejar diferentes formatos de fecha
            if (typeof delito.fecha === 'string' && delito.fecha.includes('/')) {
              // Formato DD/MM/YYYY
              anoDelito = delito.fecha.split('/')[2];
            } else if (typeof delito.fecha === 'number') {
              // Timestamp
              const fechaObj = new Date(delito.fecha);
              anoDelito = fechaObj.getFullYear().toString();
            } else if (typeof delito.fecha === 'string' && delito.fecha.includes('-')) {
              // Formato YYYY-MM-DD
              anoDelito = delito.fecha.split('-')[0];
            } else {
              // Intentar crear fecha y extraer a√±o
              try {
                const fechaObj = new Date(delito.fecha);
                anoDelito = fechaObj.getFullYear().toString();
              } catch (error) {
                anoDelito = null;
              }
            }

            if (anoDelito !== anoSeleccionado) return false;
          }

          return true;
        });

        // Aplicar filtro de nivel de riesgo si est√° activo
        if (nivelRiesgo > 1) {
          datosFiltrados = filtrarPorNivelRiesgo(datosFiltrados, nivelRiesgo);
        }

        // Actualizar datos globales
        delitosData = datosFiltrados;

        // Limpiar capas existentes
        puntosLayer.clearLayers();
        zonasRiesgoLayer.clearLayers();
        if (leyendaControl) {
          map.removeControl(leyendaControl);
        }

        // Recrear visualizaciones
        if (delitosData.length > 0) {
          crearPuntosDelitos();
          crearZonasRiesgoSimples();
          actualizarEstadisticas();
        }

        // Mostrar resultados del filtro
        mostrarResultadosFiltro(datosFiltrados.length, delitosOriginales.length);

        console.log(`Filtros aplicados: ${datosFiltrados.length} de ${delitosOriginales.length} delitos`);
        mostrarNotificacion(`‚ú® Filtros aplicados: ${datosFiltrados.length} delitos mostrados`);
      } catch (error) {
        console.error('Error aplicando filtros:', error);
        mostrarError('Error aplicando filtros: ' + error.message);
      }
    }

    function limpiarFiltros() {
      try {
        // Restaurar datos originales
        delitosData = [...delitosOriginales];

        // Limpiar formulario
        document.getElementById('filtro-ano').value = '';
        document.getElementById('nivel-riesgo').value = '1';

        // Marcar todos los tipos de delito
        document.querySelectorAll('#tipos-delito input[type="checkbox"]').forEach(checkbox => {
          checkbox.checked = true;
        });

        // Limpiar capas y recrear
        puntosLayer.clearLayers();
        zonasRiesgoLayer.clearLayers();
        if (leyendaControl) {
          map.removeControl(leyendaControl);
        }

        crearPuntosDelitos();
        crearZonasRiesgoSimples();
        actualizarEstadisticas();

        // Limpiar resultados
        document.getElementById('resultados-filtro').style.display = 'none';

        console.log('Filtros limpiados');
        mostrarNotificacion('üßπ Todos los filtros han sido limpiados');
      } catch (error) {
        console.error('Error limpiando filtros:', error);
      }
    }

    function mostrarResultadosFiltro(filtrados, total) {
      const porcentaje = ((filtrados / total) * 100).toFixed(1);
      const resultadosDiv = document.getElementById('resultados-filtro');
      resultadosDiv.style.display = 'block';
      resultadosDiv.innerHTML = `
        <strong>üìä Resultados del Filtro</strong><br>
        <br>Se muestran <span style="color: #667eea; font-weight: bold;">${filtrados}</span> de ${total} delitos (${porcentaje}%)<br>
        <small>Los datos en el mapa han sido actualizados</small>
      `;
    }

    function filtrarPorNivelRiesgo(delitos, nivelMinimo) {
      try {
        // Agrupar delitos por proximidad (igual que en crearZonasRiesgoSimples)
        const grupos = [];
        const radio = 100; // 100 metros de radio

        delitos.forEach(delito => {
          let grupoEncontrado = false;

          for (let grupo of grupos) {
            const distancia = turf.distance(
              turf.point([delito.lng, delito.lat]),
              turf.point([grupo.centro.lng, grupo.centro.lat]),
              { units: 'meters' }
            );

            if (distancia <= radio) {
              grupo.delitos.push(delito);
              grupoEncontrado = true;
              break;
            }
          }

          if (!grupoEncontrado) {
            grupos.push({
              centro: { lat: delito.lat, lng: delito.lng },
              delitos: [delito]
            });
          }
        });

        // Filtrar grupos seg√∫n el nivel m√≠nimo y devolver los delitos
        const delitosFiltrados = [];
        grupos.forEach(grupo => {
          const cantidad = grupo.delitos.length;
          let nivelGrupo = 1; // Bajo por defecto

          if (cantidad >= 5) {
            nivelGrupo = 5; // Muy Alto
          } else if (cantidad >= 3) {
            nivelGrupo = 3; // Alto
          } else if (cantidad >= 2) {
            nivelGrupo = 2; // Medio
          }

          // Si el grupo cumple con el nivel m√≠nimo, agregar sus delitos
          if (nivelGrupo >= nivelMinimo) {
            delitosFiltrados.push(...grupo.delitos);
          }
        });

        console.log(`Filtro nivel de riesgo: ${delitosFiltrados.length} delitos cumplen nivel ${nivelMinimo}`);
        return delitosFiltrados;

      } catch (error) {
        console.error('Error filtrando por nivel de riesgo:', error);
        return delitos; // Devolver datos originales en caso de error
      }
    }

    // Funci√≥n para cambiar el tipo de mapa
    function cambiarTipoMapa() {
      try {
        // Cambiar al siguiente tipo de mapa
        tipoMapaActual = (tipoMapaActual + 1) % tiposMapas.length;

        // Remover la capa actual
        if (currentTileLayer) {
          map.removeLayer(currentTileLayer);
        }

        // Agregar la nueva capa
        currentTileLayer = L.tileLayer(tiposMapas[tipoMapaActual].url, {
          maxZoom: 20,
          attribution: tiposMapas[tipoMapaActual].attribution
        }).addTo(map);

        console.log('Mapa cambiado a:', tiposMapas[tipoMapaActual].nombre);

        // Mostrar notificaci√≥n
        mostrarNotificacion(`üó∫Ô∏è ${tiposMapas[tipoMapaActual].nombre}`);

      } catch (error) {
        console.error('Error cambiando tipo de mapa:', error);
        mostrarError('Error cambiando tipo de mapa: ' + error.message);
      }
    }

    // Event listeners para toggle de estad√≠sticas y leyenda
    function toggleEstadisticas() {
      try {
        const estadisticasEl = document.getElementById('estadisticas');
        const botonEl = document.getElementById('btn-toggle-estadisticas');
        mostrandoEstadisticas = !mostrandoEstadisticas;

        if (mostrandoEstadisticas) {
          estadisticasEl.style.display = 'block';
          botonEl.classList.remove('inactivo');
          botonEl.classList.add('activo');
          mostrarNotificacion('üìä Estad√≠sticas mostradas');
        } else {
          estadisticasEl.style.display = 'none';
          botonEl.classList.remove('activo');
          botonEl.classList.add('inactivo');
          mostrarNotificacion('üìä Estad√≠sticas ocultadas');
        }
      } catch (error) {
        console.error('Error toggle estad√≠sticas:', error);
      }
    }

    function toggleLeyenda() {
      try {
        const botonEl = document.getElementById('btn-toggle-leyenda');
        mostrandoLeyenda = !mostrandoLeyenda;

        if (mostrandoLeyenda) {
          // Solo recrear la leyenda si hay datos y zonas visibles
          if (delitosData.length > 0) {
            crearLeyendaZonas();
          }
          botonEl.classList.remove('inactivo');
          botonEl.classList.add('activo');
          mostrarNotificacion('üîç Leyenda mostrada');
        } else {
          // Solo remover la leyenda, no las zonas
          if (leyendaControl) {
            map.removeControl(leyendaControl);
            leyendaControl = null;
          }
          botonEl.classList.remove('activo');
          botonEl.classList.add('inactivo');
          mostrarNotificacion('üîç Leyenda ocultada');
        }
      } catch (error) {
        console.error('Error toggle leyenda:', error);
      }
    }

    // Funci√≥n para inicializar el estado visual de los botones
    function inicializarEstadoBotones() {
      try {
        // Bot√≥n de puntos
        const btnPuntos = document.getElementById('btn-toggle-puntos');
        if (mostrandoPuntos) {
          btnPuntos.classList.add('activo');
          btnPuntos.classList.remove('inactivo');
        } else {
          btnPuntos.classList.add('inactivo');
          btnPuntos.classList.remove('activo');
        }

        // Bot√≥n de zonas
        const btnZonas = document.getElementById('btn-toggle-zonas');
        if (mostrandoZonas) {
          btnZonas.classList.add('activo');
          btnZonas.classList.remove('inactivo');
        } else {
          btnZonas.classList.add('inactivo');
          btnZonas.classList.remove('activo');
        }

        // Bot√≥n de estad√≠sticas
        const btnEstadisticas = document.getElementById('btn-toggle-estadisticas');
        if (mostrandoEstadisticas) {
          btnEstadisticas.classList.add('activo');
          btnEstadisticas.classList.remove('inactivo');
        } else {
          btnEstadisticas.classList.add('inactivo');
          btnEstadisticas.classList.remove('activo');
        }

        // Bot√≥n de leyenda
        const btnLeyenda = document.getElementById('btn-toggle-leyenda');
        if (mostrandoLeyenda) {
          btnLeyenda.classList.add('activo');
          btnLeyenda.classList.remove('inactivo');
        } else {
          btnLeyenda.classList.add('inactivo');
          btnLeyenda.classList.remove('activo');
        }

        console.log('Estado inicial de botones configurado:', {
          puntos: mostrandoPuntos,
          zonas: mostrandoZonas,
          estadisticas: mostrandoEstadisticas,
          leyenda: mostrandoLeyenda
        });

        // Informar al usuario sobre el estado inicial
        const estadoInicial = [];
        if (mostrandoZonas) estadoInicial.push('üîµ Zonas activas');
        if (mostrandoPuntos) estadoInicial.push('üìç Puntos activos');
        if (!mostrandoZonas && !mostrandoPuntos) estadoInicial.push('‚ùå Todo desactivado');

        if (estadoInicial.length > 0) {
          setTimeout(() => {
            mostrarNotificacion(`‚ÑπÔ∏è Estado inicial: ${estadoInicial.join(', ')}`, 4000);
          }, 2000);
        }

      } catch (error) {
        console.error('Error inicializando estado de botones:', error);
      }
    }
  </script>
</body>

</html>