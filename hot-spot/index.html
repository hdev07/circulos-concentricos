<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Mapa de Pol√≠gonos - CTM El Risco</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    body {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 0;
    }

    .container {
      max-width: none;
      margin: 0;
      padding: 20px;
    }

    .header {
      background: white;
      border-radius: 20px;
      padding: 20px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
      margin: 0 auto 20px auto;
      text-align: center;
    }

    .header h1 {
      color: #2c3e50;
      font-size: 2.2rem;
      margin-bottom: 5px;
      font-weight: 700;
    }

    .subtitle {
      color: #7f8c8d;
      font-size: 1rem;
      margin-bottom: 12px;
    }

    .mapa-container {
      background: white;
      border-radius: 20px;
      padding: 20px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
      position: relative;
      margin: 0 -20px;
      border-radius: 0;
    }

    .mapa-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      flex-wrap: wrap;
      gap: 15px;
    }

    .mapa-title {
      color: #2c3e50;
      font-size: 1.8rem;
      font-weight: 600;
      margin: 0;
    }

    .controles-mapa {
      display: flex;
      gap: 10px;
    }

    .control-btn {
      padding: 10px 15px;
      background: #f8f9fa;
      border: 2px solid #e9ecef;
      border-radius: 15px;
      cursor: pointer;
      font-size: 0.9rem;
      font-weight: 500;
      transition: all 0.3s ease;
      color: #495057;
    }

    .control-btn:hover {
      background: #667eea;
      color: white;
      border-color: #667eea;
      transform: translateY(-1px);
    }

    #map {
      height: 80vh;
      width: 100%;
      border-radius: 15px;
      overflow: hidden;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
    }

    .leyenda {
      position: absolute;
      bottom: 20px;
      left: 20px;
      padding: 15px;
      background: rgba(255, 255, 255, 0.95);
      border-radius: 15px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
      width: 280px;
      backdrop-filter: blur(5px);
      font-size: 0.9rem;
      z-index: 1000;
    }

    .leyenda h4 {
      margin: 0 0 15px;
      font-size: 1.1rem;
      color: #2c3e50;
      border-bottom: 2px solid #667eea;
      padding-bottom: 8px;
      text-align: center;
    }

    .leyenda-item {
      display: flex;
      align-items: center;
      margin-bottom: 8px;
      padding: 5px;
      border-radius: 8px;
      transition: background 0.2s ease;
    }

    .leyenda-item:hover {
      background: #f8f9fa;
    }

    .color-box {
      width: 20px;
      height: 20px;
      margin-right: 10px;
      border-radius: 4px;
      border: 1px solid rgba(0, 0, 0, 0.1);
      flex-shrink: 0;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .container {
        padding: 10px;
      }

      .header {
        padding: 15px;
        margin-bottom: 15px;
      }

      .header h1 {
        font-size: 1.8rem;
      }

      .mapa-container {
        margin: 0 -10px;
        padding: 15px;
      }

      .mapa-header {
        flex-direction: column;
        gap: 10px;
      }

      .mapa-title {
        font-size: 1.4rem;
        text-align: center;
      }

      .controles-mapa {
        justify-content: center;
        flex-wrap: wrap;
      }

      .control-btn {
        padding: 8px 12px;
        font-size: 0.8rem;
      }

      #map {
        height: 70vh;
      }

      .leyenda {
        position: fixed;
        bottom: 10px;
        left: 10px;
        right: 10px;
        width: auto;
        max-width: 300px;
        margin: 0 auto;
      }
    }

    .filtros-container {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 20px;
      margin-bottom: 10px;
    }

    .filtro-card {
      background: #f8f9fa;
      border-radius: 10px;
      padding: 15px;
      border: 2px solid #e9ecef;
      transition: all 0.3s ease;
    }

    .filtro-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
      border-color: #667eea;
    }

    .filtro-card h3 {
      color: #2c3e50;
      font-size: 1rem;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .filtro-card select {
      width: 100%;
      padding: 8px;
      border: 2px solid #e9ecef;
      border-radius: 6px;
      font-size: 0.9rem;
      background: white;
      transition: border-color 0.3s ease;
    }

    .filtro-card select:focus {
      outline: none;
      border-color: #667eea;
    }

    /* Estilos para la nueva columna de tipos de delito */
    .filtro-tipos-delito {
      flex: 2;
    }

    .tipos-chips {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      max-height: 200px;
      overflow-y: auto;
      padding: 10px;
      background: white;
      border-radius: 8px;
      border: 2px solid #e9ecef;
    }

    /* Estilos para los chips */
    .chip {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 8px 12px;
      background: #f8f9fa;
      border: 2px solid #e9ecef;
      border-radius: 20px;
      font-size: 0.85rem;
      cursor: pointer;
      transition: all 0.3s ease;
      user-select: none;
      min-height: 36px;
    }

    .chip:hover {
      transform: translateY(-1px);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .chip.activo {
      background: linear-gradient(45deg, #667eea, #764ba2);
      color: white;
      border-color: #667eea;
    }

    .chip.maestro {
      background: rgba(102, 126, 234, 0.1);
      border-color: #667eea;
      font-weight: bold;
      color: #2c3e50;
      margin-bottom: 8px;
      width: 100%;
      justify-content: center;
    }

    .chip.maestro.activo {
      background: #667eea;
      color: white;
    }

    /* Estilos para la columna de otros filtros */
    .filtro-otros {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    .filtro-grupo {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .filtro-grupo h3 {
      color: #2c3e50;
      font-size: 1rem;
      margin: 0;
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .filtro-grupo select {
      width: 100%;
      padding: 10px;
      border: 2px solid #e9ecef;
      border-radius: 8px;
      font-size: 0.9rem;
      background: white;
      transition: border-color 0.3s ease;
    }

    .filtro-grupo select:focus {
      outline: none;
      border-color: #667eea;
    }

    .botones-container {
      display: flex;
      gap: 10px;
      justify-content: center;
      margin-bottom: 10px;
    }

    .btn {
      padding: 8px 16px;
      border: none;
      border-radius: 15px;
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .btn-primary {
      background: linear-gradient(45deg, #667eea, #764ba2);
      color: white;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
    }

    .btn-secondary {
      background: #6c757d;
      color: white;
    }

    .btn-secondary:hover {
      background: #5a6268;
      transform: translateY(-2px);
    }

    .resultados-filtro {
      background: #e3f2fd;
      border: 1px solid #2196f3;
      border-radius: 8px;
      padding: 10px;
      margin-top: 10px;
      font-size: 0.9rem;
    }

    .resultados-filtro h4 {
      margin: 0 0 8px 0;
      color: #1976d2;
      font-size: 1rem;
    }

    .estadisticas {
      position: absolute;
      top: 90px;
      right: 30px;
      background: rgba(255, 255, 255, 0.95);
      padding: 20px;
      border-radius: 15px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
      z-index: 1000;
      min-width: 220px;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .estadisticas h4 {
      color: #2c3e50;
      margin: 0 0 15px 0;
      font-size: 1.2rem;
      text-align: center;
      border-bottom: 2px solid #667eea;
      padding-bottom: 8px;
    }

    .stat-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
      padding: 8px;
      background: rgba(102, 126, 234, 0.1);
      border-radius: 8px;
      font-size: 0.9rem;
    }

    .stat-number {
      font-weight: bold;
      color: #667eea;
      font-size: 1.1rem;
    }

    /* Bot√≥n de regreso al √≠ndice principal */
    .back-button {
      position: fixed;
      top: 20px;
      left: 20px;
      background: rgba(255, 255, 255, 0.95);
      border: none;
      border-radius: 50px;
      padding: 12px 20px;
      cursor: pointer;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
      transition: all 0.3s ease;
      z-index: 1000;
      backdrop-filter: blur(10px);
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      font-size: 0.9rem;
      font-weight: 600;
      color: #2c3e50;
      border: 2px solid rgba(102, 126, 234, 0.2);
    }

    .back-button:hover {
      background: white;
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
      border-color: #667eea;
      color: #667eea;
    }

    @media (max-width: 768px) {
      .back-button {
        position: relative;
        top: auto;
        left: auto;
        margin-bottom: 15px;
        width: 100%;
        text-align: center;
      }
    }
  </style>
</head>

<body>
  <!-- Bot√≥n de regreso al √≠ndice principal -->
  <button class="back-button" onclick="window.location.href='../index.html'">
    ‚Üê Volver al √çndice Principal
  </button>

  <div class="container">
    <!-- Header con t√≠tulo -->
    <div class="header">
      <h1>üó∫Ô∏è Mapa de Hot Spots</h1>
      <p class="subtitle">CTM El Risco - An√°lisis de zonas de seguridad con c√≠rculos de 50m</p>

      <!-- Filtros principales -->
      <div class="filtros-container">
        <div class="filtro-card filtro-tipos-delito">
          <h3>üìä Tipos de Delito</h3>
          <div class="tipos-chips" id="tipos-delito">
            <!-- Se llenar√°n din√°micamente como chips -->
          </div>
        </div>

        <div class="filtro-card filtro-otros">
          <div class="filtro-grupo">
            <h3>üóìÔ∏è A√±o</h3>
            <select id="filtro-ano">
              <option value="">Todos los a√±os</option>
              <!-- Se llenar√°n din√°micamente -->
            </select>
          </div>

          <div class="filtro-grupo">
            <h3>üìà Nivel de An√°lisis</h3>
            <select id="nivel-analisis">
              <option value="1">üü¢ Mostrar todos los hot spots</option>
              <option value="2">üü° Hot spots con delitos</option>
              <option value="3">üü† Hot spots de riesgo moderado+</option>
              <option value="4">üî¥ Hot spots de alto riesgo+</option>
              <option value="5">‚ö´ Solo hot spots muy peligrosos</option>
            </select>
          </div>
        </div>
      </div>

      <!-- Botones de acci√≥n -->
      <div class="botones-container">
        <button class="btn btn-primary" id="btn-aplicar-filtros">
          üîç Aplicar Filtros
        </button>
        <button class="btn btn-secondary" id="btn-limpiar-filtros">
          üßπ Limpiar Filtros
        </button>
      </div>

      <!-- Resultados de filtros -->
      <div class="resultados-filtro" id="resultados-filtro" style="display: none;">
        <!-- Se mostrar√° informaci√≥n de los filtros aplicados -->
      </div>
    </div>

    <!-- Container del mapa -->
    <div class="mapa-container">
      <div class="mapa-header">
        <h2 class="mapa-title">üèòÔ∏è Mapa Interactivo</h2>
        <div class="controles-mapa">
          <button class="control-btn" id="btn-centrar">üéØ Centrar</button>
          <button class="control-btn" id="btn-cambiar-mapa">üó∫Ô∏è Cambiar Mapa</button>
          <button class="control-btn" id="btn-toggle-leyenda">üîç Leyenda</button>
          <button class="control-btn" id="btn-toggle-circulos">üéØ Hot Spots</button>
          <button class="control-btn" id="btn-toggle-estadisticas">üìä Estad√≠sticas</button>
        </div>
      </div>

      <div id="map"></div>

      <!-- Estad√≠sticas flotantes -->
      <div class="estadisticas" id="estadisticas" style="display: none;">
        <h4>üìä Estad√≠sticas</h4>
        <div class="stat-item">
          <span>Total delitos:</span>
          <span class="stat-number" id="total-delitos-num">0</span>
        </div>
        <div class="stat-item">
          <span>Hot spots:</span>
          <span class="stat-number" id="hotspots-num">10</span>
        </div>
        <div class="stat-item">
          <span>Filtrados:</span>
          <span class="stat-number" id="delitos-filtrados">0</span>
        </div>
        <div class="stat-item">
          <span>Zonas seguras:</span>
          <span class="stat-number" id="zonas-seguras">0</span>
        </div>
      </div>

      <!-- Leyenda -->
      <div class="leyenda" id="leyenda">
        <h4>üìç Leyenda</h4>
        <div class="leyenda-item">
          <div class="color-box" style="background-color: rgba(102, 126, 234, 0.3); border-color: #667eea;"></div>
          <span>CTM El Risco</span>
        </div>
      </div>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
  <script src="../datos/delitos.js"></script>
  <script>
    // Variables globales
    let map;
    let currentMapType = 'osm';
    let poligonoLayer;
    let circulos = [];
    let mostrandoCirculos = true;
    let mostrandoEstadisticas = false;
    let delitosOriginales = [];
    let delitosData = [];
    let filtrosActivos = {
      tiposDelito: [],
      ano: '',
      nivelAnalisis: 1
    };

    // Pol√≠gono de CTM El Risco
    const poligonoElRisco = {
      "type": "Feature",
      "properties": {
        "name": "CTM El Risco",
        "description": "√Årea de CTM El Risco"
      },
      "geometry": {
        "type": "Polygon",
        "coordinates": [[
          [-99.09740966399839, 19.51266487533441],
          [-99.10056001114475, 19.51184350019888],
          [-99.1006093896991, 19.511303564087626],
          [-99.09965400636638, 19.509148468250586],
          [-99.09932498626866, 19.509227827856975],
          [-99.098853531969, 19.509016322113567],
          [-99.09863095442408, 19.509346968554595],
          [-99.0981457328141, 19.509095591825343],
          [-99.09843057741668, 19.508495805177503],
          [-99.09604558848774, 19.50725339452788],
          [-99.09533437072858, 19.5074291381071],
          [-99.09286947300322, 19.506017748674992],
          [-99.09259666715131, 19.505876914674985],
          [-99.09040664577094, 19.5095740415083],
          [-99.09493725520933, 19.51130173772033],
          [-99.09740966399839, 19.51266487533441]
        ]]
      }
    };

    // Configuraci√≥n de mapas base
    const mapLayers = {
      osm: {
        layer: L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: '¬© OpenStreetMap contributors'
        }),
        name: 'OpenStreetMap'
      },
      satellite: {
        layer: L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
          attribution: '¬© Esri'
        }),
        name: 'Sat√©lite'
      },
      terrain: {
        layer: L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
          attribution: '¬© OpenTopoMap contributors'
        }),
        name: 'Terreno'
      }
    };

    // Funci√≥n para verificar si un punto est√° dentro del pol√≠gono
    function puntoEnPoligono(lat, lng, poligono) {
      const coords = poligono.geometry.coordinates[0];
      let dentro = false;

      for (let i = 0, j = coords.length - 1; i < coords.length; j = i++) {
        const xi = coords[i][0], yi = coords[i][1];
        const xj = coords[j][0], yj = coords[j][1];

        if (((yi > lat) !== (yj > lat)) && (lng < (xj - xi) * (lat - yi) / (yj - yi) + xi)) {
          dentro = !dentro;
        }
      }

      return dentro;
    }

    // Funci√≥n para calcular los hot spots distribuidos uniformemente
    function calcularHotSpots() {
      console.log('üìä Calculando hot spots distribuidos...');

      // Obtener l√≠mites del pol√≠gono
      const coords = poligonoElRisco.geometry.coordinates[0];
      let minLat = Infinity, maxLat = -Infinity;
      let minLng = Infinity, maxLng = -Infinity;

      coords.forEach(coord => {
        const lng = coord[0];
        const lat = coord[1];
        minLat = Math.min(minLat, lat);
        maxLat = Math.max(maxLat, lat);
        minLng = Math.min(minLng, lng);
        maxLng = Math.max(maxLng, lng);
      });

      console.log(`üìç L√≠mites del pol√≠gono: Lat(${minLat.toFixed(6)} - ${maxLat.toFixed(6)}), Lng(${minLng.toFixed(6)} - ${maxLng.toFixed(6)})`);

      // Crear cuadr√≠cula m√°s densa para mejor cobertura con c√≠rculos de 50m
      const hotSpots = [];
      const filas = 5; // Aumentado a 5 filas
      const columnas = 6; // Aumentado a 6 columnas = 30 puntos base

      const deltaLat = (maxLat - minLat) / (filas + 1);
      const deltaLng = (maxLng - minLng) / (columnas + 1);

      // Crear puntos en cuadr√≠cula regular m√°s densa
      for (let fila = 1; fila <= filas; fila++) {
        for (let col = 1; col <= columnas; col++) {
          const lat = minLat + (deltaLat * fila);
          const lng = minLng + (deltaLng * col);

          // Verificar si el punto est√° dentro del pol√≠gono
          if (puntoEnPoligono(lat, lng, poligonoElRisco)) {
            hotSpots.push({
              lat: lat,
              lng: lng,
              fila: fila,
              columna: col,
              id: `${fila}-${col}`
            });
          }
        }
      }

      // Agregar puntos adicionales en los bordes y esquinas para mejor cobertura
      const puntosAdicionales = [
        // Puntos en bordes superiores e inferiores
        { lat: minLat + deltaLat * 0.3, lng: minLng + deltaLng * 1.5, id: 'borde-sup-1' },
        { lat: minLat + deltaLat * 0.3, lng: minLng + deltaLng * 3, id: 'borde-sup-2' },
        { lat: minLat + deltaLat * 0.3, lng: minLng + deltaLng * 4.5, id: 'borde-sup-3' },
        { lat: minLat + deltaLat * 5.7, lng: minLng + deltaLng * 1.5, id: 'borde-inf-1' },
        { lat: minLat + deltaLat * 5.7, lng: minLng + deltaLng * 3, id: 'borde-inf-2' },
        { lat: minLat + deltaLat * 5.7, lng: minLng + deltaLng * 4.5, id: 'borde-inf-3' },

        // Puntos en bordes laterales
        { lat: minLat + deltaLat * 2, lng: minLng + deltaLng * 0.3, id: 'borde-izq-1' },
        { lat: minLat + deltaLat * 3, lng: minLng + deltaLng * 0.3, id: 'borde-izq-2' },
        { lat: minLat + deltaLat * 4, lng: minLng + deltaLng * 0.3, id: 'borde-izq-3' },
        { lat: minLat + deltaLat * 2, lng: minLng + deltaLng * 6.7, id: 'borde-der-1' },
        { lat: minLat + deltaLat * 3, lng: minLng + deltaLng * 6.7, id: 'borde-der-2' },
        { lat: minLat + deltaLat * 4, lng: minLng + deltaLng * 6.7, id: 'borde-der-3' },

        // Puntos intermedios para mejor cobertura
        { lat: minLat + deltaLat * 1.5, lng: minLng + deltaLng * 2.5, id: 'inter-1' },
        { lat: minLat + deltaLat * 2.5, lng: minLng + deltaLng * 1.5, id: 'inter-2' },
        { lat: minLat + deltaLat * 3.5, lng: minLng + deltaLng * 2.5, id: 'inter-3' },
        { lat: minLat + deltaLat * 4.5, lng: minLng + deltaLng * 3.5, id: 'inter-4' },
        { lat: minLat + deltaLat * 2.5, lng: minLng + deltaLng * 4.5, id: 'inter-5' },
        { lat: minLat + deltaLat * 3.5, lng: minLng + deltaLng * 5.5, id: 'inter-6' }
      ];

      puntosAdicionales.forEach(punto => {
        if (puntoEnPoligono(punto.lat, punto.lng, poligonoElRisco)) {
          hotSpots.push(punto);
        }
      });

      // Tomar los primeros 20 hot spots para mejor rendimiento
      const hotSpotsFinales = hotSpots.slice(0, 20);

      // Calcular delitos en cada hot spot (radio de 50 metros)
      const radioInfluencia = 0.00045; // Aproximadamente 50 metros

      hotSpotsFinales.forEach((hotSpot, index) => {
        const delitosEnZona = delitosData.filter(delito => {
          const distancia = Math.sqrt(
            Math.pow(delito.lat - hotSpot.lat, 2) +
            Math.pow(delito.lng - hotSpot.lng, 2)
          );
          return distancia <= radioInfluencia;
        });

        // Contar tipos de delitos
        const tiposDelitos = {};
        delitosEnZona.forEach(delito => {
          if (!tiposDelitos[delito.tipoDelito]) {
            tiposDelitos[delito.tipoDelito] = 0;
          }
          tiposDelitos[delito.tipoDelito]++;
        });

        // Encontrar el tipo m√°s com√∫n
        const tipoMasComun = Object.keys(tiposDelitos).length > 0
          ? Object.keys(tiposDelitos).reduce((a, b) => tiposDelitos[a] > tiposDelitos[b] ? a : b)
          : 'Sin delitos';

        hotSpot.cantidad = delitosEnZona.length;
        hotSpot.tipos = tiposDelitos;
        hotSpot.tipoMasComun = tipoMasComun;
        hotSpot.numero = index + 1;

        console.log(`üéØ Hot Spot #${index + 1}: ${delitosEnZona.length} delitos en radio de 50m`);
      });

      // Filtrar hot spots seg√∫n nivel de an√°lisis
      let hotSpotsFiltrados = hotSpotsFinales;

      switch (filtrosActivos.nivelAnalisis) {
        case 2: // Hot spots con delitos
          hotSpotsFiltrados = hotSpotsFinales.filter(hs => hs.cantidad > 0);
          break;
        case 3: // Riesgo moderado+
          hotSpotsFiltrados = hotSpotsFinales.filter(hs => hs.cantidad >= 4);
          break;
        case 4: // Alto riesgo+
          hotSpotsFiltrados = hotSpotsFinales.filter(hs => hs.cantidad >= 7);
          break;
        case 5: // Muy peligrosos
          hotSpotsFiltrados = hotSpotsFinales.filter(hs => hs.cantidad >= 10);
          break;
        default: // Mostrar todos
          hotSpotsFiltrados = hotSpotsFinales;
      }

      // Ordenar por cantidad de delitos (mayor a menor) para referencia
      const hotSpotsOrdenados = [...hotSpotsFiltrados].sort((a, b) => b.cantidad - a.cantidad);

      console.log('üî• Hot Spots ordenados por peligrosidad:');
      hotSpotsOrdenados.forEach((hs, i) => {
        console.log(`${i + 1}. Hot Spot #${hs.numero}: ${hs.cantidad} delitos - ${hs.tipoMasComun}`);
      });

      return hotSpotsFiltrados;
    }

    // Funci√≥n para obtener color seg√∫n cantidad de delitos
    function obtenerColorHotSpot(cantidad) {
      if (cantidad === 0) return '#4caf50'; // Verde - Sin delitos
      if (cantidad <= 2) return '#8bc34a'; // Verde claro - Muy pocos delitos
      if (cantidad <= 4) return '#ffeb3b'; // Amarillo - Pocos delitos
      if (cantidad <= 7) return '#ff9800'; // Naranja - Delitos moderados
      if (cantidad <= 10) return '#ff5722'; // Rojo naranja - Muchos delitos
      return '#f44336'; // Rojo intenso - Zona muy peligrosa
    }

    // Funci√≥n para obtener nivel de riesgo
    function obtenerNivelRiesgo(cantidad) {
      if (cantidad === 0) return { nivel: 'Muy Seguro', emoji: 'üü¢' };
      if (cantidad <= 2) return { nivel: 'Seguro', emoji: 'üü¢' };
      if (cantidad <= 4) return { nivel: 'Precauci√≥n', emoji: 'üü°' };
      if (cantidad <= 7) return { nivel: 'Riesgo Moderado', emoji: 'üü†' };
      if (cantidad <= 10) return { nivel: 'Riesgo Alto', emoji: 'üî¥' };
      return { nivel: 'Muy Peligroso', emoji: '‚ö´' };
    }

    // Funci√≥n para obtener emoji seg√∫n tipo de delito m√°s com√∫n
    function obtenerEmojiDelito(tipoDelito) {
      const emojis = {
        'Robo': 'üîì',
        'Violencia Familiar': 'üë®‚Äçüë©‚Äçüëß‚Äçüë¶',
        'Fraude': 'üí≥',
        'Amenazas': '‚ö†Ô∏è',
        'Narcomenudeo': 'üíä',
        'Abuso Sexual': 'üö´',
        'Lesiones Dolosas': 'ü§ï',
        'Usurpaci√≥n': 'üè†',
        'Da√±o A La Propiedad': 'üî®',
        'Tentativa': '‚ö°',
        'Extorsi√≥n': 'üí∞',
        'Despojo': 'üì¶',
        'Abuso De Confianza': 'ü§ù',
        'Encubrimiento': 'üïµÔ∏è',
        'Allanamiento': 'üö™'
      };

      return emojis[tipoDelito] || 'üìç';
    }

    // Funci√≥n para agregar hot spots
    function agregarHotSpots() {
      // Limpiar c√≠rculos existentes
      circulos.forEach(circulo => map.removeLayer(circulo));
      circulos = [];

      if (!mostrandoCirculos) return;

      const hotSpots = calcularHotSpots();

      if (hotSpots.length === 0) {
        console.log('‚ö†Ô∏è No se pudieron crear hot spots');
        return;
      }

      hotSpots.forEach((hotSpot, index) => {
        const color = obtenerColorHotSpot(hotSpot.cantidad);
        const riesgo = obtenerNivelRiesgo(hotSpot.cantidad);
        const emoji = obtenerEmojiDelito(hotSpot.tipoMasComun);
        const radio = 50; // Radio fijo de 50 metros

        // Crear c√≠rculo
        const circulo = L.circle([hotSpot.lat, hotSpot.lng], {
          color: color,
          fillColor: color,
          fillOpacity: 0.5,
          radius: radio,
          weight: 2
        });

        // Crear contenido del popup
        let tiposTexto = 'No hay delitos registrados en esta √°rea';
        if (Object.keys(hotSpot.tipos).length > 0) {
          tiposTexto = Object.keys(hotSpot.tipos)
            .map(tipo => `‚Ä¢ ${tipo}: ${hotSpot.tipos[tipo]} casos`)
            .join('<br>');
        }

        const popupContent = `
          <div style="text-align: center; padding: 12px; min-width: 240px;">
            <h3 style="margin: 0 0 10px 0; color: #2c3e50;">
              üéØ Hot Spot #${hotSpot.numero}
            </h3>
            <div style="background: ${color}; color: white; padding: 10px; border-radius: 8px; margin-bottom: 12px;">
              <strong>${riesgo.emoji} ${riesgo.nivel}</strong><br>
              <span style="font-size: 1.1rem;">${hotSpot.cantidad} delitos en 50m de radio</span>
            </div>
            <div style="text-align: left; font-size: 0.9rem; background: #f8f9fa; padding: 10px; border-radius: 6px;">
              <strong>üìç Cobertura:</strong><br>
              Radio de 50 metros (${hotSpot.id})
              <br><br>
              <strong>üîç An√°lisis de seguridad:</strong><br>
              ${hotSpot.cantidad > 0 ?
            `Delito principal: ${emoji} ${hotSpot.tipoMasComun}<br><br><strong>Distribuci√≥n:</strong><br>${tiposTexto}` :
            '‚úÖ √Årea completamente segura<br>Sin delitos registrados'
          }
            </div>
          </div>
        `;

        circulo.bindPopup(popupContent);

        // Tooltip al pasar el mouse
        circulo.bindTooltip(
          `üéØ Hot Spot #${hotSpot.numero}: ${riesgo.emoji} ${hotSpot.cantidad} delitos (50m)`,
          { permanent: false, direction: 'top' }
        );

        // Agregar al mapa y al array
        circulo.addTo(map);
        circulos.push(circulo);
      });

      console.log(`‚úÖ ${hotSpots.length} hot spots de 50m distribuidos agregados`);

      // Actualizar leyenda
      actualizarLeyendaHotSpots(hotSpots);
    }

    // Funci√≥n para actualizar la leyenda de hot spots
    function actualizarLeyendaHotSpots(hotSpots) {
      const leyenda = document.getElementById('leyenda');

      let contenidoLeyenda = `
        <h4>üìç Leyenda</h4>
        <div class="leyenda-item">
          <div class="color-box" style="background-color: rgba(102, 126, 234, 0.3); border-color: #667eea;"></div>
          <span>CTM El Risco</span>
        </div>
      `;

      if (mostrandoCirculos && hotSpots.length > 0) {
        contenidoLeyenda += `
          <div style="margin-top: 15px; border-top: 1px solid #eee; padding-top: 10px;">
            <h5 style="margin: 0 0 10px 0;">üéØ Hot Spots (Radio: 50m)</h5>
        `;

        // Niveles de riesgo actualizados para 50m
        const niveles = [
          { cantidad: 0, color: '#4caf50', texto: 'Muy Seguro', emoji: 'üü¢', desc: '0 delitos' },
          { cantidad: 1, color: '#8bc34a', texto: 'Seguro', emoji: 'üü¢', desc: '1-2 delitos' },
          { cantidad: 3, color: '#ffeb3b', texto: 'Precauci√≥n', emoji: 'üü°', desc: '3-4 delitos' },
          { cantidad: 5, color: '#ff9800', texto: 'Riesgo Moderado', emoji: 'üü†', desc: '5-7 delitos' },
          { cantidad: 8, color: '#ff5722', texto: 'Riesgo Alto', emoji: 'üî¥', desc: '8-10 delitos' },
          { cantidad: 11, color: '#f44336', texto: 'Muy Peligroso', emoji: '‚ö´', desc: '11+ delitos' }
        ];

        niveles.forEach(nivel => {
          contenidoLeyenda += `
            <div class="leyenda-item">
              <div class="color-box" style="background-color: ${nivel.color};"></div>
              <span>${nivel.emoji} ${nivel.texto} (${nivel.desc})</span>
            </div>
          `;
        });

        // Estad√≠sticas generales
        const totalDelitos = hotSpots.reduce((sum, hs) => sum + hs.cantidad, 0);
        const hotSpotMasPeligroso = hotSpots.length > 0 ? hotSpots.reduce((max, hs) => hs.cantidad > max.cantidad ? hs : max, hotSpots[0]) : null;
        const hotSpotsSeguras = hotSpots.filter(hs => hs.cantidad === 0).length;

        contenidoLeyenda += `
          <div style="margin-top: 12px; padding-top: 8px; border-top: 1px solid #eee; font-size: 0.8rem; color: #666;">
            <strong>üìä Estad√≠sticas:</strong><br>
            ‚Ä¢ Total de delitos: ${totalDelitos}<br>
            ${hotSpotMasPeligroso ? `‚Ä¢ Hot Spot m√°s peligroso: #${hotSpotMasPeligroso.numero} (${hotSpotMasPeligroso.cantidad} delitos)<br>` : ''}
            ‚Ä¢ Zonas seguras: ${hotSpotsSeguras}/${hotSpots.length}<br>
            ‚Ä¢ Radio de an√°lisis: 50 metros c/u
          </div>
        `;

        contenidoLeyenda += '</div>';

        // Actualizar estad√≠sticas flotantes
        document.getElementById('zonas-seguras').textContent = hotSpotsSeguras;
        document.getElementById('hotspots-num').textContent = hotSpots.length;
      }

      leyenda.innerHTML = contenidoLeyenda;
    }

    // Inicializar mapa
    function initMap() {
      // Crear mapa centrado en CTM El Risco
      const center = [19.509, -99.095];
      map = L.map('map').setView(center, 15);

      // Agregar capa base inicial
      mapLayers[currentMapType].layer.addTo(map);

      // Inicializar filtros
      inicializarFiltros();

      // Agregar pol√≠gono
      addPolygon();

      // Agregar hot spots
      agregarHotSpots();

      // Configurar controles
      setupControls();

      // Actualizar estad√≠sticas iniciales
      actualizarEstadisticas();
    }

    // Agregar pol√≠gono al mapa
    function addPolygon() {
      const style = {
        fillColor: '#667eea',
        weight: 3,
        opacity: 1,
        color: '#667eea',
        fillOpacity: 0.3
      };

      poligonoLayer = L.geoJSON(poligonoElRisco, {
        style: style,
        onEachFeature: function (feature, layer) {
          if (feature.properties && feature.properties.name) {
            layer.bindPopup(`
              <div style="text-align: center; padding: 10px;">
                <h3 style="margin: 0 0 10px 0; color: #2c3e50;">${feature.properties.name}</h3>
                <p style="margin: 0; color: #7f8c8d;">${feature.properties.description}</p>
              </div>
            `);
          }
        }
      }).addTo(map);

      // Ajustar vista al pol√≠gono
      map.fitBounds(poligonoLayer.getBounds(), { padding: [20, 20] });
    }

    // Configurar controles
    function setupControls() {
      // Bot√≥n centrar
      document.getElementById('btn-centrar').addEventListener('click', function () {
        if (poligonoLayer) {
          map.fitBounds(poligonoLayer.getBounds(), { padding: [20, 20] });
        }
      });

      // Bot√≥n cambiar mapa
      document.getElementById('btn-cambiar-mapa').addEventListener('click', function () {
        const mapTypes = Object.keys(mapLayers);
        const currentIndex = mapTypes.indexOf(currentMapType);
        const nextIndex = (currentIndex + 1) % mapTypes.length;
        currentMapType = mapTypes[nextIndex];

        // Remover capa actual
        map.eachLayer(function (layer) {
          if (layer instanceof L.TileLayer) {
            map.removeLayer(layer);
          }
        });

        // Agregar nueva capa
        mapLayers[currentMapType].layer.addTo(map);

        // Actualizar texto del bot√≥n
        this.innerHTML = `üó∫Ô∏è ${mapLayers[currentMapType].name}`;
      });

      // Bot√≥n toggle leyenda
      document.getElementById('btn-toggle-leyenda').addEventListener('click', function () {
        const leyenda = document.getElementById('leyenda');
        if (leyenda.style.display === 'none') {
          leyenda.style.display = 'block';
          this.innerHTML = 'üîç Ocultar Leyenda';
        } else {
          leyenda.style.display = 'none';
          this.innerHTML = 'üîç Mostrar Leyenda';
        }
      });

      // Bot√≥n toggle c√≠rculos de calor
      document.getElementById('btn-toggle-circulos').addEventListener('click', function () {
        mostrandoCirculos = !mostrandoCirculos;

        if (mostrandoCirculos) {
          agregarHotSpots();
          this.innerHTML = 'üéØ Ocultar Hot Spots';
        } else {
          circulos.forEach(circulo => map.removeLayer(circulo));
          circulos = [];
          this.innerHTML = 'üéØ Mostrar Hot Spots';

          // Actualizar leyenda sin c√≠rculos
          const leyenda = document.getElementById('leyenda');
          leyenda.innerHTML = `
            <h4>üìç Leyenda</h4>
            <div class="leyenda-item">
              <div class="color-box" style="background-color: rgba(102, 126, 234, 0.3); border-color: #667eea;"></div>
              <span>CTM El Risco</span>
            </div>
          `;
        }
      });

      // Bot√≥n toggle estad√≠sticas
      document.getElementById('btn-toggle-estadisticas').addEventListener('click', function () {
        mostrandoEstadisticas = !mostrandoEstadisticas;
        const estadisticas = document.getElementById('estadisticas');

        if (mostrandoEstadisticas) {
          estadisticas.style.display = 'block';
          this.innerHTML = 'üìä Ocultar Estad√≠sticas';
        } else {
          estadisticas.style.display = 'none';
          this.innerHTML = 'üìä Mostrar Estad√≠sticas';
        }
      });
    }

    // Inicializar cuando se carga la p√°gina
    document.addEventListener('DOMContentLoaded', function () {
      initMap();
    });

    // Funci√≥n para obtener los datos de delitos
    function obtenerDelitosData() {
      try {
        if (typeof DELITOS_DATA !== 'undefined' && DELITOS_DATA.length > 0) {
          console.log(`üìä Delitos cargados: ${DELITOS_DATA.length}`);
          return DELITOS_DATA;
        } else {
          throw new Error('No se encontraron datos de delitos');
        }
      } catch (error) {
        console.error('‚ùå Error obteniendo datos de delitos:', error);
        return [];
      }
    }

    // Funci√≥n para inicializar los filtros
    function inicializarFiltros() {
      delitosOriginales = obtenerDelitosData();
      delitosData = [...delitosOriginales];

      // Crear chips de tipos de delito
      crearChipsTiposDelito();

      // Llenar select de a√±os
      llenarSelectAnos();

      // Configurar event listeners
      configurarEventListeners();

      console.log('üîß Filtros inicializados');
    }

    // Funci√≥n para crear chips de tipos de delito
    function crearChipsTiposDelito() {
      const tiposContainer = document.getElementById('tipos-delito');
      const tiposUnicos = [...new Set(delitosOriginales.map(d => d.tipoDelito))].sort();

      // Chip maestro para seleccionar/deseleccionar todos
      const chipMaestro = document.createElement('div');
      chipMaestro.className = 'chip maestro';
      chipMaestro.innerHTML = 'üìã Todos los tipos de delito';
      chipMaestro.addEventListener('click', toggleTodosTipos);
      tiposContainer.appendChild(chipMaestro);

      // Chips individuales
      tiposUnicos.forEach(tipo => {
        const chip = document.createElement('div');
        chip.className = 'chip';
        chip.dataset.tipo = tipo;
        chip.innerHTML = `${obtenerEmojiDelito(tipo)} ${tipo}`;
        chip.addEventListener('click', () => toggleTipoDelito(tipo));
        tiposContainer.appendChild(chip);
      });
    }

    // Funci√≥n para llenar select de a√±os
    function llenarSelectAnos() {
      const selectAno = document.getElementById('filtro-ano');
      const anos = [...new Set(delitosOriginales.map(d => {
        const fecha = d.fecha;
        if (typeof fecha === 'string' && fecha.includes('/')) {
          return fecha.split('/')[2];
        }
        return new Date(fecha).getFullYear().toString();
      }))].sort().reverse();

      anos.forEach(ano => {
        const option = document.createElement('option');
        option.value = ano;
        option.textContent = ano;
        selectAno.appendChild(option);
      });
    }

    // Funci√≥n para toggle todos los tipos
    function toggleTodosTipos() {
      const chipMaestro = document.querySelector('.chip.maestro');
      const chipsIndividuales = document.querySelectorAll('.chip:not(.maestro)');

      if (chipMaestro.classList.contains('activo')) {
        // Deseleccionar todos
        chipMaestro.classList.remove('activo');
        chipsIndividuales.forEach(chip => chip.classList.remove('activo'));
        filtrosActivos.tiposDelito = [];
      } else {
        // Seleccionar todos
        chipMaestro.classList.add('activo');
        chipsIndividuales.forEach(chip => {
          chip.classList.add('activo');
          filtrosActivos.tiposDelito.push(chip.dataset.tipo);
        });
      }
    }

    // Funci√≥n para toggle tipo individual
    function toggleTipoDelito(tipo) {
      const chip = document.querySelector(`[data-tipo="${tipo}"]`);
      const chipMaestro = document.querySelector('.chip.maestro');

      if (chip.classList.contains('activo')) {
        chip.classList.remove('activo');
        filtrosActivos.tiposDelito = filtrosActivos.tiposDelito.filter(t => t !== tipo);
      } else {
        chip.classList.add('activo');
        filtrosActivos.tiposDelito.push(tipo);
      }

      // Actualizar chip maestro
      const totalTipos = document.querySelectorAll('.chip:not(.maestro)').length;
      const tiposSeleccionados = filtrosActivos.tiposDelito.length;

      if (tiposSeleccionados === totalTipos) {
        chipMaestro.classList.add('activo');
      } else {
        chipMaestro.classList.remove('activo');
      }
    }

    // Funci√≥n para configurar event listeners
    function configurarEventListeners() {
      // Bot√≥n aplicar filtros
      document.getElementById('btn-aplicar-filtros').addEventListener('click', aplicarFiltros);

      // Bot√≥n limpiar filtros
      document.getElementById('btn-limpiar-filtros').addEventListener('click', limpiarFiltros);

      // Select de a√±o
      document.getElementById('filtro-ano').addEventListener('change', (e) => {
        filtrosActivos.ano = e.target.value;
      });

      // Select de nivel de an√°lisis
      document.getElementById('nivel-analisis').addEventListener('change', (e) => {
        filtrosActivos.nivelAnalisis = parseInt(e.target.value);
      });
    }

    // Funci√≥n para aplicar filtros
    function aplicarFiltros() {
      console.log('üîç Aplicando filtros:', filtrosActivos);

      // Filtrar datos
      delitosData = delitosOriginales.filter(delito => {
        // Filtro por tipo de delito
        if (filtrosActivos.tiposDelito.length > 0 &&
          !filtrosActivos.tiposDelito.includes(delito.tipoDelito)) {
          return false;
        }

        // Filtro por a√±o
        if (filtrosActivos.ano) {
          const anoDelito = typeof delito.fecha === 'string' && delito.fecha.includes('/')
            ? delito.fecha.split('/')[2]
            : new Date(delito.fecha).getFullYear().toString();

          if (anoDelito !== filtrosActivos.ano) {
            return false;
          }
        }

        return true;
      });

      // Actualizar hot spots con datos filtrados
      agregarHotSpots();

      // Mostrar resultados
      mostrarResultadosFiltros();

      // Actualizar estad√≠sticas
      actualizarEstadisticas();
    }

    // Funci√≥n para limpiar filtros
    function limpiarFiltros() {
      // Resetear filtros
      filtrosActivos = {
        tiposDelito: [],
        ano: '',
        nivelAnalisis: 1
      };

      // Limpiar UI
      document.querySelectorAll('.chip').forEach(chip => chip.classList.remove('activo'));
      document.getElementById('filtro-ano').value = '';
      document.getElementById('nivel-analisis').value = '1';
      document.getElementById('resultados-filtro').style.display = 'none';

      // Restaurar datos originales
      delitosData = [...delitosOriginales];

      // Actualizar mapa
      agregarHotSpots();
      actualizarEstadisticas();

      console.log('üßπ Filtros limpiados');
    }

    // Funci√≥n para mostrar resultados de filtros
    function mostrarResultadosFiltros() {
      const resultadosDiv = document.getElementById('resultados-filtro');
      const totalOriginal = delitosOriginales.length;
      const totalFiltrado = delitosData.length;

      if (filtrosActivos.tiposDelito.length > 0 || filtrosActivos.ano || filtrosActivos.nivelAnalisis > 1) {
        resultadosDiv.style.display = 'block';
        resultadosDiv.innerHTML = `
          <h4>üîç Filtros Aplicados</h4>
          <p><strong>Delitos mostrados:</strong> ${totalFiltrado} de ${totalOriginal} totales</p>
          ${filtrosActivos.tiposDelito.length > 0 ? `<p><strong>Tipos:</strong> ${filtrosActivos.tiposDelito.join(', ')}</p>` : ''}
          ${filtrosActivos.ano ? `<p><strong>A√±o:</strong> ${filtrosActivos.ano}</p>` : ''}
          ${filtrosActivos.nivelAnalisis > 1 ? `<p><strong>Nivel de an√°lisis:</strong> ${document.getElementById('nivel-analisis').selectedOptions[0].text}</p>` : ''}
        `;
      } else {
        resultadosDiv.style.display = 'none';
      }
    }

    // Funci√≥n para actualizar estad√≠sticas
    function actualizarEstadisticas() {
      document.getElementById('total-delitos-num').textContent = delitosOriginales.length;
      document.getElementById('delitos-filtrados').textContent = delitosData.length;
    }
  </script>
</body>

</html>